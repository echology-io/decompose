<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vanta Engine — Document Processor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

  * { margin:0; padding:0; box-sizing:border-box; }

  :root {
    --bg: #0c0e13;
    --surface: #13161d;
    --surface2: #1a1e27;
    --border: #252a36;
    --border-active: #3d4555;
    --text: #c8cdd8;
    --text-dim: #6b7280;
    --text-bright: #e8ecf4;
    --accent: #3b82f6;
    --accent-dim: #1e3a5f;
    --green: #22c55e;
    --green-dim: #14532d;
    --amber: #f59e0b;
    --amber-dim: #78350f;
    --red: #ef4444;
    --red-dim: #7f1d1d;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'DM Sans', sans-serif;
  }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── HEADER ── */
  header {
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-mark {
    width: 32px; height: 32px;
    background: var(--accent);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--mono); font-weight: 700; font-size: 14px;
    color: #fff;
  }
  .logo-text {
    font-family: var(--mono);
    font-weight: 600;
    font-size: 15px;
    color: var(--text-bright);
    letter-spacing: -0.02em;
  }
  .logo-text span { color: var(--text-dim); font-weight: 400; }
  .header-status {
    display: flex; gap: 16px; align-items: center;
    font-family: var(--mono); font-size: 11px;
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    display: inline-block; margin-right: 5px;
  }
  .status-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.off { background: var(--red); }

  /* ── LAYOUT ── */
  .container {
    display: grid;
    grid-template-columns: 380px 1fr;
    min-height: calc(100vh - 57px);
  }

  /* ── LEFT PANEL: DROP ZONE + FILE LIST ── */
  .left-panel {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--surface);
  }

  .drop-zone {
    margin: 16px;
    padding: 40px 24px;
    border: 2px dashed var(--border);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-dim);
  }
  .drop-zone.dragover {
    transform: scale(1.01);
  }
  .drop-icon {
    font-size: 32px;
    margin-bottom: 12px;
    opacity: 0.5;
  }
  .drop-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-bright);
    margin-bottom: 4px;
  }
  .drop-sub {
    font-size: 12px;
    color: var(--text-dim);
  }
  .drop-zone input { display: none; }

  .controls {
    padding: 0 16px 12px;
    display: flex; gap: 8px;
  }
  .btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    border-radius: 6px;
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    font-weight: 500;
  }
  .btn:hover { border-color: var(--border-active); background: var(--border); }
  .btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .btn.primary:hover { opacity: 0.9; }
  .btn.primary:disabled {
    opacity: 0.4; cursor: not-allowed;
  }
  .btn.danger { border-color: var(--red-dim); color: var(--red); }
  .btn.danger:hover { background: var(--red-dim); }

  /* ── FILE LIST ── */
  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 16px;
  }
  .file-list-header {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }
  .file-item {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
  }
  .file-item:hover { border-color: var(--border-active); }
  .file-item.selected { border-color: var(--accent); background: var(--accent-dim); }
  .file-item.processing { border-color: var(--amber); }
  .file-item.complete { border-left: 3px solid var(--green); }
  .file-item.failed { border-left: 3px solid var(--red); }

  .file-name {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-bright);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 280px;
  }
  .file-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 3px;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .file-badge {
    font-family: var(--mono);
    font-size: 9px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .badge-queued { background: var(--surface2); color: var(--text-dim); }
  .badge-processing { background: var(--amber-dim); color: var(--amber); }
  .badge-complete { background: var(--green-dim); color: var(--green); }
  .badge-failed { background: var(--red-dim); color: var(--red); }

  .file-progress {
    height: 2px;
    background: var(--border);
    border-radius: 1px;
    margin-top: 6px;
    overflow: hidden;
  }
  .file-progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 1px;
    transition: width 0.3s;
    animation: pulse 1.5s ease infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .file-remove {
    position: absolute;
    top: 8px; right: 8px;
    background: none; border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .file-item:hover .file-remove { opacity: 1; }
  .file-remove:hover { color: var(--red); }

  /* ── RIGHT PANEL: RESULTS ── */
  .right-panel {
    display: flex;
    flex-direction: column;
    background: var(--bg);
  }
  .results-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface);
  }
  .results-title {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
  }
  .results-actions {
    display: flex; gap: 8px;
  }

  .results-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
  }

  /* ── EMPTY STATE ── */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    text-align: center;
  }
  .empty-state .icon { font-size: 48px; opacity: 0.3; margin-bottom: 16px; }
  .empty-state .title { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: var(--text); }
  .empty-state .sub { font-size: 12px; }

  /* ── RESULT CARDS ── */
  .result-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .stat-label {
    font-family: var(--mono);
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .stat-value {
    font-family: var(--mono);
    font-size: 20px;
    font-weight: 700;
    color: var(--text-bright);
  }
  .stat-value.type {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
  }

  /* ── JSON VIEWER ── */
  .json-section {
    margin-top: 16px;
  }
  .json-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    width: 100%;
    text-align: left;
    transition: background 0.15s;
  }
  .json-toggle:hover { background: var(--surface2); }
  .json-toggle .arrow { transition: transform 0.2s; }
  .json-toggle.open .arrow { transform: rotate(90deg); }

  .json-content {
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
  }
  .json-content.open { display: block; }
  .json-pre {
    padding: 16px;
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.6;
    color: var(--text);
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
    white-space: pre;
    tab-size: 2;
  }
  /* JSON syntax colors */
  .json-key { color: #7dd3fc; }
  .json-string { color: #86efac; }
  .json-number { color: #fbbf24; }
  .json-bool { color: #c084fc; }
  .json-null { color: #6b7280; }

  /* ── BATCH PROGRESS ── */
  .batch-bar {
    padding: 12px 16px;
    background: var(--surface2);
    border-top: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 11px;
    display: none;
    align-items: center;
    gap: 12px;
  }
  .batch-bar.active { display: flex; }
  .batch-progress-track {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .batch-progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s;
  }
  .batch-text { color: var(--text-dim); white-space: nowrap; }
  .batch-count { color: var(--text-bright); font-weight: 600; }

  /* ── SCROLLBAR ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-active); }

  /* ── RESPONSIVE ── */
  @media (max-width: 800px) {
    .container { grid-template-columns: 1fr; }
    .left-panel { border-right: none; border-bottom: 1px solid var(--border); max-height: 50vh; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-mark">V</div>
    <div class="logo-text">vanta<span> — document processor</span></div>
  </div>
  <div class="header-status">
    <span><span class="status-dot" id="engineDot"></span><span id="engineStatus">checking...</span></span>
  </div>
</header>

<div class="container">
  <!-- LEFT: Drop zone + file list -->
  <div class="left-panel">
    <div class="drop-zone" id="dropZone">
      <div class="drop-icon">⬇</div>
      <div class="drop-title">Drop files here</div>
      <div class="drop-sub">PDF, DOCX, TXT, CSV, DXF, images — multiple files ok</div>
      <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.md,.csv,.xml,.html,.json,.dxf,.rtf,.png,.jpg,.jpeg,.tiff,.tif,.bmp,.gif">
    </div>

    <div class="controls">
      <button class="btn primary" id="processBtn" disabled>Process All</button>
      <button class="btn" id="clearBtn">Clear</button>
      <button class="btn" id="exportBtn" style="margin-left:auto">Export JSONL</button>
    </div>

    <div class="file-list" id="fileList">
      <div class="file-list-header">Documents (<span id="fileCount">0</span>)</div>
    </div>

    <div class="batch-bar" id="batchBar">
      <span class="batch-text"><span class="batch-count" id="batchCurrent">0</span> / <span id="batchTotal">0</span></span>
      <div class="batch-progress-track">
        <div class="batch-progress-fill" id="batchFill"></div>
      </div>
      <span class="batch-text" id="batchLabel">Processing...</span>
    </div>
  </div>

  <!-- RIGHT: Results viewer -->
  <div class="right-panel">
    <div class="results-header">
      <div class="results-title" id="resultsTitle">Select a document</div>
      <div class="results-actions">
        <button class="btn" id="copyJsonBtn" style="display:none">Copy JSON</button>
        <button class="btn" id="downloadJsonBtn" style="display:none">Download</button>
      </div>
    </div>
    <div class="results-body" id="resultsBody">
      <div class="empty-state">
        <div class="icon">◇</div>
        <div class="title">No results yet</div>
        <div class="sub">Drop documents and click Process All</div>
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api/process';
const HEALTH = '/api/health';
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ── STATE ──
let files = [];        // {id, file, status, results, error}
let selectedId = null;
let processing = false;

// ── ELEMENTS ──
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const fileCount = document.getElementById('fileCount');
const processBtn = document.getElementById('processBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const resultsBody = document.getElementById('resultsBody');
const resultsTitle = document.getElementById('resultsTitle');
const copyJsonBtn = document.getElementById('copyJsonBtn');
const downloadJsonBtn = document.getElementById('downloadJsonBtn');
const batchBar = document.getElementById('batchBar');
const batchCurrent = document.getElementById('batchCurrent');
const batchTotal = document.getElementById('batchTotal');
const batchFill = document.getElementById('batchFill');
const batchLabel = document.getElementById('batchLabel');
const engineDot = document.getElementById('engineDot');
const engineStatus = document.getElementById('engineStatus');

// ── HEALTH CHECK ──
async function checkHealth() {
  try {
    const r = await fetch(HEALTH);
    const d = await r.json();
    engineDot.className = 'status-dot on';
    const parts = [];
    if (d.vanta_classify_v2) parts.push('classify_v2');
    if (d.ollama) parts.push(d.ollama_model || 'ollama');
    if (d.vanta_govern) parts.push('full pipeline');
    else if (d.vanta_compress) parts.push('compress');
    else if (d.vanta_core) parts.push('core');
    engineStatus.textContent = parts.join(' · ') || 'connected';
  } catch {
    engineDot.className = 'status-dot off';
    engineStatus.textContent = 'offline';
  }
}
checkHealth();
setInterval(checkHealth, 30000);

// ── FILE HANDLING ──
function addFiles(newFiles) {
  for (const f of newFiles) {
    const ext = f.name.toLowerCase().split('.').pop();
    const allowed = ['pdf','docx','doc','txt','md','csv','xml','html','json','dxf','rtf','png','jpg','jpeg','tiff','tif','bmp','gif'];
    if (!allowed.includes(ext)) continue;
    if (files.find(x => x.file.name === f.name && x.file.size === f.size)) continue;
    files.push({
      id: crypto.randomUUID().slice(0, 8),
      file: f,
      status: 'queued',
      results: null,
      error: null,
    });
  }
  render();
}

// ── DROP ZONE ──
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => { addFiles(e.target.files); fileInput.value = ''; });

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});

// ── CONTROLS ──
clearBtn.addEventListener('click', () => {
  if (processing) return;
  files = [];
  selectedId = null;
  render();
  renderResults();
});

exportBtn.addEventListener('click', () => {
  const completed = files.filter(f => f.status === 'complete' && f.results);
  if (!completed.length) return;
  const lines = completed.map(f => JSON.stringify({
    timestamp: new Date().toISOString(),
    filename: f.file.name,
    results: f.results,
  }));
  const blob = new Blob([lines.join('\n') + '\n'], { type: 'application/x-ndjson' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vanta_batch_${new Date().toISOString().slice(0,10)}.jsonl`;
  a.click();
});

copyJsonBtn.addEventListener('click', () => {
  const f = files.find(x => x.id === selectedId);
  if (f?.results) {
    navigator.clipboard.writeText(JSON.stringify(f.results, null, 2));
    copyJsonBtn.textContent = 'Copied!';
    setTimeout(() => copyJsonBtn.textContent = 'Copy JSON', 1500);
  }
});

downloadJsonBtn.addEventListener('click', () => {
  const f = files.find(x => x.id === selectedId);
  if (f?.results) {
    const blob = new Blob([JSON.stringify(f.results, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = f.file.name.replace(/\.[^.]+$/, '_vanta.json');
    a.click();
  }
});

// ── PROCESS ──
processBtn.addEventListener('click', () => processAll());

async function processAll() {
  const queued = files.filter(f => f.status === 'queued');
  if (!queued.length || processing) return;

  processing = true;
  processBtn.disabled = true;
  batchBar.classList.add('active');
  batchTotal.textContent = queued.length;
  let done = 0;

  // Process one at a time for clear progress feedback
  for (const f of queued) {
    f.status = 'processing';
    batchCurrent.textContent = done + 1;
    batchLabel.textContent = f.file.name;
    batchFill.style.width = `${((done) / queued.length) * 100}%`;
    render();

    // Auto-select the processing file
    selectedId = f.id;
    renderResults();

    try {
      const form = new FormData();
      form.append('files', f.file);
      const resp = await fetch(API, { method: 'POST', body: form });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || `HTTP ${resp.status}`);
      }

      const data = await resp.json();
      const result = data.results?.[0];
      if (result?.status === 'processed') {
        f.status = 'complete';
        f.results = result.results;
      } else {
        f.status = 'failed';
        f.error = result?.error || 'Unknown error';
      }
    } catch (err) {
      f.status = 'failed';
      f.error = err.message;
    }

    done++;
    batchFill.style.width = `${(done / queued.length) * 100}%`;
    render();
    renderResults();
  }

  batchLabel.textContent = `Done — ${done} processed`;
  processing = false;
  processBtn.disabled = false;
  setTimeout(() => batchBar.classList.remove('active'), 3000);
  render();
}

// ── RENDER FILE LIST ──
function render() {
  const header = fileList.querySelector('.file-list-header');
  fileList.innerHTML = '';
  fileList.appendChild(header);
  fileCount.textContent = files.length;

  processBtn.disabled = processing || !files.some(f => f.status === 'queued');

  for (const f of files) {
    const el = document.createElement('div');
    el.className = `file-item ${f.status}${f.id === selectedId ? ' selected' : ''}`;
    el.onclick = () => { selectedId = f.id; render(); renderResults(); };

    const sizeMB = (f.file.size / 1024 / 1024).toFixed(1);
    const badgeClass = {queued:'badge-queued',processing:'badge-processing',complete:'badge-complete',failed:'badge-failed'}[f.status];

    let typeLabel = '';
    if (f.results?.classification?.type) {
      typeLabel = ` · <span style="color:var(--accent)">${esc(f.results.classification.type)}</span>`;
    }

    el.innerHTML = `
      <div class="file-name">${esc(f.file.name)}</div>
      <div class="file-meta">
        <span>${sizeMB} MB</span>
        <span class="file-badge ${badgeClass}">${f.status}</span>
        ${typeLabel}
      </div>
      ${f.status === 'processing' ? '<div class="file-progress"><div class="file-progress-bar" style="width:60%"></div></div>' : ''}
      ${f.status === 'queued' ? '<button class="file-remove" onclick="event.stopPropagation();removeFile(\''+esc(f.id)+'\')">✕</button>' : ''}
    `;
    fileList.appendChild(el);
  }
}

function removeFile(id) {
  files = files.filter(f => f.id !== id);
  if (selectedId === id) selectedId = null;
  render();
  renderResults();
}

// ── RENDER RESULTS ──
function renderResults() {
  const f = files.find(x => x.id === selectedId);

  if (!f) {
    resultsTitle.textContent = 'Select a document';
    copyJsonBtn.style.display = 'none';
    downloadJsonBtn.style.display = 'none';
    resultsBody.innerHTML = `
      <div class="empty-state">
        <div class="icon">◇</div>
        <div class="title">No results yet</div>
        <div class="sub">Drop documents and click Process All</div>
      </div>`;
    return;
  }

  resultsTitle.textContent = f.file.name;

  if (f.status === 'queued') {
    copyJsonBtn.style.display = 'none';
    downloadJsonBtn.style.display = 'none';
    resultsBody.innerHTML = `
      <div class="empty-state">
        <div class="icon">◇</div>
        <div class="title">Queued</div>
        <div class="sub">Click Process All to begin</div>
      </div>`;
    return;
  }

  if (f.status === 'processing') {
    copyJsonBtn.style.display = 'none';
    downloadJsonBtn.style.display = 'none';
    resultsBody.innerHTML = `
      <div class="empty-state">
        <div class="icon" style="animation: pulse 1.5s ease infinite">◈</div>
        <div class="title">Processing...</div>
        <div class="sub">Running through Vanta pipeline</div>
      </div>`;
    return;
  }

  if (f.status === 'failed') {
    copyJsonBtn.style.display = 'none';
    downloadJsonBtn.style.display = 'none';
    resultsBody.innerHTML = `
      <div class="empty-state">
        <div class="icon" style="color:var(--red)">✕</div>
        <div class="title" style="color:var(--red)">Processing Failed</div>
        <div class="sub">${f.error || 'Unknown error'}</div>
      </div>`;
    return;
  }

  // ── COMPLETE: Show results ──
  copyJsonBtn.style.display = '';
  downloadJsonBtn.style.display = '';
  const r = f.results;
  const cls = r.classification || {};

  resultsBody.innerHTML = `
    <div class="result-summary">
      <div class="stat-card">
        <div class="stat-label">Document Type</div>
        <div class="stat-value type">${cls.type || '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Confidence</div>
        <div class="stat-value">${cls.confidence != null ? Math.round(cls.confidence * 100) + '%' : '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pages</div>
        <div class="stat-value">${r.pages_analyzed ?? '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Words</div>
        <div class="stat-value">${(r.word_count || 0).toLocaleString()}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Semantic Units</div>
        <div class="stat-value">${r.semantic_units ?? '—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Standards</div>
        <div class="stat-value">${r.standards_found ?? 0}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Obligations</div>
        <div class="stat-value">${r.obligations_found ?? 0}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Risk Flags</div>
        <div class="stat-value">${r.risk_flags ?? 0}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Entities</div>
        <div class="stat-value">${r.entities_found ?? 0}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Engine</div>
        <div class="stat-value type">${r.engine || '—'}</div>
      </div>
      ${r.quality_score?.grade ? `
      <div class="stat-card">
        <div class="stat-label">Quality</div>
        <div class="stat-value">${r.quality_score.score || r.quality_score.grade}</div>
      </div>` : ''}
      ${r.processing_time_seconds != null ? `
      <div class="stat-card">
        <div class="stat-label">Time</div>
        <div class="stat-value">${r.processing_time_seconds}s</div>
      </div>` : ''}
    </div>

    ${r.executive_summary ? `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:16px">
      <div class="stat-label" style="margin-bottom:6px">Executive Summary</div>
      <div style="font-size:13px;line-height:1.6;color:var(--text)">${r.executive_summary}</div>
    </div>` : ''}

    ${r.content_summary ? `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:16px">
      <div class="stat-label" style="margin-bottom:6px">AI Content Summary</div>
      <div style="font-size:13px;line-height:1.6;color:var(--text)">${r.content_summary}</div>
    </div>` : ''}

    ${r.content_domains?.length ? `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:16px">
      <div class="stat-label" style="margin-bottom:6px">Content Domains</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">${r.content_domains.map(d => `<span class="file-badge badge-complete">${d}</span>`).join('')}</div>
    </div>` : ''}

    ${r.pipeline_stages?.length ? `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:16px">
      <div class="stat-label" style="margin-bottom:6px">Pipeline</div>
      <div style="font-family:var(--mono);font-size:12px;color:var(--text-dim)">${r.pipeline_stages.join(' → ')}</div>
    </div>` : ''}

    <div class="json-section">
      <button class="json-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        <span class="arrow">▶</span> Full JSON Output
      </button>
      <div class="json-content">
        <div class="json-pre">${syntaxHighlight(JSON.stringify(r, null, 2))}</div>
      </div>
    </div>
  `;
}

function syntaxHighlight(json) {
  return json.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"([^"]+)"(?=\s*:)/g, '<span class="json-key">"$1"</span>')
    .replace(/:\s*"([^"]*?)"/g, ': <span class="json-string">"$1"</span>')
    .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
    .replace(/:\s*(true|false)/g, ': <span class="json-bool">$1</span>')
    .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
}

// ── INIT ──
render();
renderResults();
</script>
</body>
</html>
