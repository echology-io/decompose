<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AECai Outreach â€” Sales Command Center</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,300&family=DM+Serif+Display&family=JetBrains+Mono:wght@400;500&display=swap');

*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0B0E11;--surface:#12161B;--surface-2:#181D24;--surface-3:#1E242C;
  --border:#2A3140;--border-light:#353D4D;
  --text:#E8E6E3;--text-mid:#9BA3B0;--text-dim:#5C6370;
  --gold:#C9A24D;--gold-dim:rgba(201,162,77,.15);--gold-glow:rgba(201,162,77,.08);
  --green:#3FB950;--green-dim:rgba(63,185,80,.12);
  --red:#F85149;--red-dim:rgba(248,81,73,.12);
  --blue:#58A6FF;--blue-dim:rgba(88,166,255,.12);
  --mono:'JetBrains Mono',monospace;--sans:'DM Sans',system-ui,sans-serif;--serif:'DM Serif Display',serif;
  --radius:10px;--radius-lg:14px;
}
html,body{height:100%;font-family:var(--sans);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}

/* â”€â”€ LAYOUT â”€â”€ */
.app{display:grid;grid-template-columns:340px 1fr;grid-template-rows:56px 1fr;height:100vh;overflow:hidden}
.topbar{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:10}
.topbar-brand{display:flex;align-items:center;gap:12px}
.topbar-logo{font-family:var(--serif);font-size:1.125rem;color:var(--gold)}
.topbar-sep{width:1px;height:20px;background:var(--border)}
.topbar-title{font-size:.8125rem;color:var(--text-mid);font-weight:500}
.topbar-status{display:flex;align-items:center;gap:16px}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.off{background:var(--red);box-shadow:0 0 6px var(--red)}
.status-label{font-size:.75rem;color:var(--text-dim);font-family:var(--mono)}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.sidebar-header{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between}
.sidebar-header h3{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--text-dim)}
.lead-count{font-size:.6875rem;color:var(--gold);font-family:var(--mono)}
.sidebar-search{padding:0 16px 12px}
.sidebar-search input{width:100%;padding:8px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:.8125rem;outline:none;transition:border-color .2s}
.sidebar-search input:focus{border-color:var(--gold)}
.sidebar-search input::placeholder{color:var(--text-dim)}
.lead-list{flex:1;overflow-y:auto;padding:0 8px 8px}
.lead-list::-webkit-scrollbar{width:4px}
.lead-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

.lead-card{padding:12px 14px;border-radius:var(--radius);cursor:pointer;transition:all .15s;margin-bottom:2px;border:1px solid transparent}
.lead-card:hover{background:var(--surface-2)}
.lead-card.active{background:var(--gold-glow);border-color:rgba(201,162,77,.2)}
.lead-card.active .lead-name{color:var(--gold)}
.lead-name{font-weight:600;font-size:.875rem;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lead-firm{font-size:.75rem;color:var(--text-mid);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lead-meta{display:flex;gap:8px;margin-top:6px}
.lead-tag{font-size:.625rem;padding:2px 7px;border-radius:4px;font-weight:600;text-transform:uppercase;letter-spacing:.06em}
.lead-tag.source{background:var(--blue-dim);color:var(--blue)}
.lead-tag.has-email{background:var(--green-dim);color:var(--green)}
.lead-tag.no-email{background:var(--red-dim);color:var(--red)}

.add-lead-btn{margin:8px 16px 16px;padding:10px;border:1px dashed var(--border);border-radius:var(--radius);background:none;color:var(--text-dim);font-family:var(--sans);font-size:.8125rem;cursor:pointer;transition:all .2s}
.add-lead-btn:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-glow)}

/* â”€â”€ MAIN CONTENT â”€â”€ */
.main{display:flex;flex-direction:column;overflow:hidden}
.main-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-dim);font-size:1rem;text-align:center;padding:40px}
.main-empty p{max-width:320px;line-height:1.7}

/* â”€â”€ LEAD DETAIL â”€â”€ */
.lead-detail{padding:28px 32px 20px;border-bottom:1px solid var(--border);background:var(--surface)}
.lead-detail-name{font-family:var(--serif);font-size:1.5rem;margin-bottom:4px}
.lead-detail-firm{font-size:1rem;color:var(--text-mid);margin-bottom:12px}
.lead-detail-row{display:flex;gap:24px;flex-wrap:wrap}
.lead-detail-item{font-size:.8125rem}
.lead-detail-item label{color:var(--text-dim);font-size:.6875rem;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:2px}
.lead-detail-item span{color:var(--text)}
.lead-detail-item a{color:var(--gold);text-decoration:none}
.lead-detail-item a:hover{text-decoration:underline}

/* â”€â”€ DRAFT CONTROLS â”€â”€ */
.draft-controls{padding:16px 32px;display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.draft-btn{padding:8px 16px;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);color:var(--text);font-family:var(--sans);font-size:.8125rem;font-weight:500;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px}
.draft-btn:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-glow)}
.draft-btn.active{border-color:var(--gold);background:var(--gold-dim);color:var(--gold)}
.draft-btn .icon{font-size:.875rem}

/* â”€â”€ DRAFT AREA â”€â”€ */
.draft-area{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:24px 32px}
.draft-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;gap:16px}
.draft-spinner{width:32px;height:32px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.draft-loading-text{font-size:.875rem;color:var(--text-mid)}

.draft-output{flex:1;overflow-y:auto;padding-right:8px}
.draft-output::-webkit-scrollbar{width:4px}
.draft-output::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

.draft-card{background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:16px;position:relative;transition:border-color .2s}
.draft-card:hover{border-color:var(--border-light)}
.draft-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.draft-card-type{font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--gold);padding:3px 8px;background:var(--gold-dim);border-radius:4px}
.draft-card-time{font-size:.6875rem;color:var(--text-dim);font-family:var(--mono)}
.draft-card-subject{font-weight:600;margin-bottom:12px;color:var(--text);font-size:.9375rem}
.draft-card-body{font-size:.875rem;line-height:1.75;color:var(--text-mid);white-space:pre-wrap;font-family:var(--sans)}
.draft-card-actions{display:flex;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.action-btn{padding:7px 14px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text);font-family:var(--sans);font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px}
.action-btn:hover{border-color:var(--gold);color:var(--gold)}
.action-btn.primary{background:var(--gold);color:var(--bg);border-color:var(--gold)}
.action-btn.primary:hover{background:#D4AF5A;box-shadow:0 2px 12px rgba(201,162,77,.3)}
.action-btn.copied{background:var(--green-dim);border-color:var(--green);color:var(--green)}

/* â”€â”€ EDIT MODE â”€â”€ */
.draft-edit{width:100%;min-height:200px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;color:var(--text);font-family:var(--sans);font-size:.875rem;line-height:1.75;resize:vertical;outline:none;transition:border-color .2s}
.draft-edit:focus{border-color:var(--gold)}

/* â”€â”€ ADD LEAD MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:32px;width:480px;max-width:90vw}
.modal h3{font-family:var(--serif);font-size:1.25rem;margin-bottom:20px}
.modal-field{margin-bottom:14px}
.modal-field label{display:block;font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px}
.modal-field input,.modal-field textarea{width:100%;padding:10px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--sans);font-size:.875rem;outline:none;transition:border-color .2s}
.modal-field input:focus,.modal-field textarea:focus{border-color:var(--gold)}
.modal-field textarea{min-height:60px;resize:vertical}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
.modal-btn{padding:10px 20px;border-radius:6px;border:none;font-family:var(--sans);font-size:.875rem;font-weight:600;cursor:pointer;transition:all .15s}
.modal-btn.cancel{background:var(--surface-2);color:var(--text-mid);border:1px solid var(--border)}
.modal-btn.cancel:hover{color:var(--text);border-color:var(--border-light)}
.modal-btn.save{background:var(--gold);color:var(--bg)}
.modal-btn.save:hover{background:#D4AF5A}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface-2);border:1px solid var(--green);color:var(--green);padding:12px 20px;border-radius:8px;font-size:.8125rem;font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:200;font-family:var(--sans)}
.toast.show{transform:translateY(0);opacity:1}
</style>
</head>
<body>
<div class="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">AECai</div>
      <div class="topbar-sep"></div>
      <div class="topbar-title">Outreach Command Center</div>
    </div>
    <div class="topbar-status">
      <span class="status-label"><span class="status-dot" id="ollamaStatus"></span>Ollama</span>
      <span class="status-label"><span class="status-dot" id="serverStatus"></span>Server</span>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Leads</h3>
      <span class="lead-count" id="leadCount">â€”</span>
    </div>
    <div class="sidebar-search">
      <input type="text" id="searchInput" placeholder="Search leads...">
    </div>
    <div class="lead-list" id="leadList"></div>
    <button class="add-lead-btn" id="addLeadBtn">+ Add Contact</button>
  </div>

  <!-- MAIN -->
  <div class="main" id="mainContent">
    <div class="main-empty" id="emptyState">
      <p>Select a lead from the sidebar or add a new contact to start drafting outreach.</p>
    </div>
  </div>
</div>

<!-- ADD LEAD MODAL -->
<div class="modal-overlay" id="addLeadModal">
  <div class="modal">
    <h3>Add Contact</h3>
    <div class="modal-field"><label>Name</label><input type="text" id="newName" placeholder="Jane Smith"></div>
    <div class="modal-field"><label>Firm</label><input type="text" id="newFirm" placeholder="Stantec, AECOM, etc."></div>
    <div class="modal-field"><label>Email</label><input type="email" id="newEmail" placeholder="jane@firm.com"></div>
    <div class="modal-field"><label>Role / Title</label><input type="text" id="newRole" placeholder="VP Engineering, Document Control, etc."></div>
    <div class="modal-field"><label>Pain Point / Notes</label><textarea id="newNotes" placeholder="What you know about their situation..."></textarea></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="modalCancel">Cancel</button>
      <button class="modal-btn save" id="modalSave">Add & Draft</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = '';  // Same-origin â€” works via Cloudflare Tunnel or localhost
const OLLAMA_URL = 'http://localhost:11434';  // Ollama always local
const MODEL = 'llama3';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let leads = [];
let selectedLead = null;
let drafts = {}; // leadId -> [drafts]
let editingDraft = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FOUNDER_CTX = `Kyle Vines, AECai founder. 13 years civil/geotech engineering. Worked at ENR #60 to #123 firms. Bought an engineering firm, went through bankruptcy. Built AI inside an ENR Top 200 firm â€” validated $1.85M/year operational value across 200 engineers. AECai runs 100% on client hardware. Air-gapped. No cloud. Offer: $800 AI Discovery Assessment, 2-week delivery, 100% credit toward full engagement ($15K-$75K).`;

const TEMPLATES = {
  linkedin: (name, firm, ctx) => `Write a LinkedIn DM from Kyle Vines (AECai founder) to ${name} at ${firm}.

LEAD CONTEXT:
${ctx}

FOUNDER: ${FOUNDER_CTX}

RULES: First person, casual but professional. Under 150 words. Reference their firm. Include $1.85M proof point naturally. End with soft question, not hard ask. No "revolutionary"/"game-changing"/emojis. Engineer-to-engineer tone.

Write only the message.`,

  email: (name, firm, ctx) => `Write a cold email from Kyle Vines (AECai founder) to ${name} at ${firm}.

LEAD CONTEXT:
${ctx}

FOUNDER: ${FOUNDER_CTX}

RULES: Subject line: lowercase, max 6 words. Plain text, max 150 words body. Open specific to their firm. Include engineering credibility. One proof point ($1.85M, "page 247" story, or "Dave retired" story). End with question. Sign: Kyle Vines / AECai / aecai.io

Format:
Subject: [line]

[body]

Kyle Vines
AECai | aecai.io`,

  followup: (name, firm, ctx, num) => `Write follow-up #${num} from Kyle Vines to ${name} at ${firm}. Previous outreach was ~7 days ago.

LEAD CONTEXT:
${ctx}

RULES: Under 80 words. Add ONE new angle. ${num >= 3 ? 'This is the break-up email â€” graceful, leave door open.' : 'More direct but not pushy.'} Never apologize for following up.

New angles: "Your best engineer is everyone's search engine â€” 3-5 interruptions/day" | "Spec review: page 247 had a compaction change contradicting geotech report" | "When a 30-year engineer walks out, knowledge is in files â€” nobody knows how to find it"

Write only the message.`,

  custom: (name, firm, ctx, prompt) => `${prompt}

LEAD CONTEXT: ${name} at ${firm}
${ctx}

FOUNDER: ${FOUNDER_CTX}

Write only the message. Under 150 words. Engineer-to-engineer tone.`
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
  await checkStatus();
  await loadLeads();
  setupEvents();
});

async function checkStatus() {
  // Server
  try {
    const r = await fetch(`${API_BASE}/api/health`, {signal: AbortSignal.timeout(3000)});
    const d = await r.json();
    document.getElementById('serverStatus').className = 'status-dot on';
  } catch { document.getElementById('serverStatus').className = 'status-dot off'; }

  // Ollama
  try {
    const r = await fetch(`${OLLAMA_URL}/api/tags`, {signal: AbortSignal.timeout(3000)});
    const d = await r.json();
    const has = d.models?.some(m => m.name?.includes(MODEL));
    document.getElementById('ollamaStatus').className = has ? 'status-dot on' : 'status-dot off';
  } catch { document.getElementById('ollamaStatus').className = 'status-dot off'; }
}

async function loadLeads() {
  try {
    const r = await fetch(`${API_BASE}/api/leads`);
    const d = await r.json();
    leads = (d.leads || []).filter(l => l.name || l.email || l.firm);
    // Deduplicate by email
    const seen = new Set();
    leads = leads.filter(l => {
      const key = (l.email || '') + (l.name || '');
      if (!key || key === '?' || seen.has(key)) return false;
      seen.add(key);
      return true;
    });
    document.getElementById('leadCount').textContent = leads.length;
    renderLeadList();
  } catch (e) {
    console.error('Failed to load leads:', e);
    document.getElementById('leadCount').textContent = 'ERR';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER LEADS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLeadList(filter = '') {
  const list = document.getElementById('leadList');
  const filtered = leads.filter(l => {
    if (!filter) return true;
    const f = filter.toLowerCase();
    return (l.name||'').toLowerCase().includes(f) || (l.firm||'').toLowerCase().includes(f) || (l.email||'').toLowerCase().includes(f);
  });

  list.innerHTML = filtered.map((l, i) => {
    const idx = leads.indexOf(l);
    const name = l.name && l.name !== '?' ? l.name : (l.email ? l.email.split('@')[0] : 'Unknown');
    const firm = l.firm && l.firm !== '?' ? l.firm : 'â€”';
    const hasEmail = l.email && l.email.includes('@');
    const source = l.source || '';
    return `<div class="lead-card ${selectedLead === idx ? 'active' : ''}" data-idx="${idx}">
      <div class="lead-name">${esc(name)}</div>
      <div class="lead-firm">${esc(firm)}</div>
      <div class="lead-meta">
        ${hasEmail ? '<span class="lead-tag has-email">Email</span>' : '<span class="lead-tag no-email">No Email</span>'}
        ${source ? `<span class="lead-tag source">${esc(source)}</span>` : ''}
      </div>
    </div>`;
  }).join('');

  // Click handlers
  list.querySelectorAll('.lead-card').forEach(card => {
    card.addEventListener('click', () => selectLead(parseInt(card.dataset.idx)));
  });
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELECT LEAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectLead(idx) {
  selectedLead = idx;
  renderLeadList(document.getElementById('searchInput').value);
  renderMain();
}

function renderMain() {
  if (selectedLead === null) return;
  const lead = leads[selectedLead];
  const name = lead.name && lead.name !== '?' ? lead.name : lead.email?.split('@')[0] || 'Unknown';
  const firm = lead.firm && lead.firm !== '?' ? lead.firm : 'â€”';
  const main = document.getElementById('mainContent');

  main.innerHTML = `
    <div class="lead-detail">
      <div class="lead-detail-name">${esc(name)}</div>
      <div class="lead-detail-firm">${esc(firm)}</div>
      <div class="lead-detail-row">
        ${lead.email && lead.email.includes('@') ? `<div class="lead-detail-item"><label>Email</label><a href="mailto:${esc(lead.email)}">${esc(lead.email)}</a></div>` : ''}
        ${lead.role ? `<div class="lead-detail-item"><label>Role</label><span>${esc(lead.role)}</span></div>` : ''}
        ${lead.source ? `<div class="lead-detail-item"><label>Source</label><span>${esc(lead.source)}</span></div>` : ''}
        ${lead.timestamp ? `<div class="lead-detail-item"><label>First Contact</label><span>${lead.timestamp.substring(0,10)}</span></div>` : ''}
        ${lead.custom || lead.pain_point ? `<div class="lead-detail-item"><label>Notes</label><span>${esc(lead.custom || lead.pain_point)}</span></div>` : ''}
      </div>
    </div>
    <div class="draft-controls">
      <button class="draft-btn" data-type="linkedin"><span class="icon">ğŸ’¬</span> LinkedIn DM</button>
      <button class="draft-btn" data-type="email"><span class="icon">âœ‰ï¸</span> Cold Email</button>
      <button class="draft-btn" data-type="followup1"><span class="icon">â†©ï¸</span> Follow-up #1</button>
      <button class="draft-btn" data-type="followup2"><span class="icon">â†©ï¸</span> Follow-up #2</button>
      <button class="draft-btn" data-type="followup3"><span class="icon">ğŸ‘‹</span> Break-up #3</button>
      <button class="draft-btn" data-type="custom"><span class="icon">âœï¸</span> Custom Prompt</button>
    </div>
    <div class="draft-area">
      <div class="draft-output" id="draftOutput">
        ${renderDrafts(lead.id || selectedLead)}
      </div>
    </div>
  `;

  // Wire draft buttons
  main.querySelectorAll('.draft-btn').forEach(btn => {
    btn.addEventListener('click', () => generateDraft(btn.dataset.type));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE DRAFT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateDraft(type) {
  const lead = leads[selectedLead];
  const name = lead.name && lead.name !== '?' ? lead.name : lead.email?.split('@')[0] || 'there';
  const firm = lead.firm && lead.firm !== '?' ? lead.firm : 'your firm';
  const ctx = buildContext(lead);
  const leadKey = lead.id || selectedLead;

  // Mark button active
  document.querySelectorAll('.draft-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(`[data-type="${type}"]`);
  if (activeBtn) activeBtn.classList.add('active');

  let prompt;
  if (type === 'custom') {
    const userPrompt = window.prompt('What should the message accomplish?', 'Write a warm intro message offering a free 15-minute call to discuss document management challenges');
    if (!userPrompt) return;
    prompt = TEMPLATES.custom(name, firm, ctx, userPrompt);
  } else if (type.startsWith('followup')) {
    const num = parseInt(type.replace('followup', ''));
    prompt = TEMPLATES.followup(name, firm, ctx, num);
  } else {
    prompt = TEMPLATES[type](name, firm, ctx);
  }

  // Show loading
  const output = document.getElementById('draftOutput');
  const loadingId = 'loading-' + Date.now();
  output.insertAdjacentHTML('afterbegin', `
    <div class="draft-loading" id="${loadingId}">
      <div class="draft-spinner"></div>
      <div class="draft-loading-text">Generating ${type.replace(/\d/,'')} draft via ${MODEL}...</div>
    </div>
  `);

  try {
    const response = await callOllama(prompt);
    document.getElementById(loadingId)?.remove();

    // Parse email subject if present
    let subject = '';
    let body = response;
    const subjectMatch = response.match(/^Subject:\s*(.+)\n\n?([\s\S]*)/i);
    if (subjectMatch) {
      subject = subjectMatch[1].trim();
      body = subjectMatch[2].trim();
    }

    // Store draft
    if (!drafts[leadKey]) drafts[leadKey] = [];
    const draft = {
      id: Date.now(),
      type: type.replace(/\d/, ''),
      subtype: type,
      subject, body,
      raw: response,
      timestamp: new Date().toISOString(),
      lead: { name, firm, email: lead.email }
    };
    drafts[leadKey].unshift(draft);

    // Render
    output.insertAdjacentHTML('afterbegin', renderDraftCard(draft));
    wireCardActions(draft.id);

  } catch (e) {
    document.getElementById(loadingId)?.remove();
    output.insertAdjacentHTML('afterbegin', `
      <div class="draft-card" style="border-color:var(--red)">
        <div class="draft-card-body" style="color:var(--red)">Error: ${esc(e.message)}</div>
      </div>
    `);
  }
}

async function callOllama(prompt) {
  const r = await fetch(`${OLLAMA_URL}/api/generate`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      model: MODEL, prompt, stream: false,
      options: { temperature: 0.7, top_p: 0.9, num_predict: 500 }
    }),
    signal: AbortSignal.timeout(60000)
  });
  if (!r.ok) throw new Error(`Ollama returned ${r.status}`);
  const d = await r.json();
  return (d.response || '').trim();
}

function buildContext(lead) {
  const parts = [];
  if (lead.name && lead.name !== '?') parts.push(`Name: ${lead.name}`);
  if (lead.email && lead.email.includes('@')) parts.push(`Email: ${lead.email}`);
  if (lead.firm && lead.firm !== '?') parts.push(`Firm: ${lead.firm}`);
  if (lead.role) parts.push(`Role: ${lead.role}`);
  if (lead.source) parts.push(`Source: ${lead.source}`);
  if (lead.custom || lead.pain_point) parts.push(`Notes: ${lead.custom || lead.pain_point}`);
  if (lead.team_size) parts.push(`Team: ${lead.team_size}`);
  return parts.length ? parts.join('\n') : 'Minimal data â€” use general approach.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER DRAFTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDrafts(leadKey) {
  const ld = drafts[leadKey] || [];
  if (!ld.length) return '<div class="main-empty" style="height:auto;padding:60px 0"><p>Click a button above to generate a draft.<br>Each draft uses Ollama (local AI) â€” nothing leaves your machine.</p></div>';
  return ld.map(d => renderDraftCard(d)).join('');
}

function renderDraftCard(draft) {
  const typeLabels = { linkedin: 'LinkedIn DM', email: 'Cold Email', followup: 'Follow-up', custom: 'Custom' };
  const label = typeLabels[draft.type] || draft.type;
  const time = new Date(draft.timestamp).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});

  return `<div class="draft-card" id="draft-${draft.id}">
    <div class="draft-card-header">
      <span class="draft-card-type">${esc(label)}</span>
      <span class="draft-card-time">${time}</span>
    </div>
    ${draft.subject ? `<div class="draft-card-subject">Subject: ${esc(draft.subject)}</div>` : ''}
    <div class="draft-card-body" id="body-${draft.id}">${esc(draft.body)}</div>
    <div class="draft-card-actions">
      <button class="action-btn primary" data-action="copy" data-id="${draft.id}">Copy</button>
      ${draft.type === 'email' && draft.lead?.email ? `<button class="action-btn" data-action="mail" data-id="${draft.id}">Open in Mail</button>` : ''}
      <button class="action-btn" data-action="edit" data-id="${draft.id}">Edit</button>
      <button class="action-btn" data-action="regen" data-id="${draft.id}">Regenerate</button>
    </div>
  </div>`;
}

function wireCardActions(draftId) {
  const card = document.getElementById(`draft-${draftId}`);
  if (!card) return;
  card.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', () => handleDraftAction(btn.dataset.action, draftId));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAFT ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleDraftAction(action, draftId) {
  const leadKey = leads[selectedLead]?.id || selectedLead;
  const draft = (drafts[leadKey] || []).find(d => d.id === draftId);
  if (!draft) return;

  if (action === 'copy') {
    const text = draft.subject ? `Subject: ${draft.subject}\n\n${draft.body}` : draft.body;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.querySelector(`[data-action="copy"][data-id="${draftId}"]`);
      if (btn) { btn.textContent = 'Copied âœ“'; btn.classList.add('copied'); setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000); }
      showToast('Draft copied to clipboard');
    });
  }

  else if (action === 'mail') {
    const subject = encodeURIComponent(draft.subject || 'Quick question');
    const body = encodeURIComponent(draft.body);
    window.open(`mailto:${draft.lead?.email || ''}?subject=${subject}&body=${body}`);
    showToast('Opening in Mail...');
  }

  else if (action === 'edit') {
    const bodyEl = document.getElementById(`body-${draftId}`);
    const actionsEl = bodyEl.nextElementSibling;
    if (bodyEl.tagName === 'TEXTAREA') {
      // Save edit
      draft.body = bodyEl.value;
      bodyEl.outerHTML = `<div class="draft-card-body" id="body-${draftId}">${esc(draft.body)}</div>`;
      actionsEl.querySelector('[data-action="edit"]').textContent = 'Edit';
      showToast('Draft updated');
    } else {
      // Enter edit mode
      bodyEl.outerHTML = `<textarea class="draft-edit" id="body-${draftId}">${esc(draft.body)}</textarea>`;
      document.getElementById(`body-${draftId}`).focus();
      actionsEl.querySelector('[data-action="edit"]').textContent = 'Save';
    }
  }

  else if (action === 'regen') {
    generateDraft(draft.subtype || draft.type);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupEvents() {
  // Search
  document.getElementById('searchInput').addEventListener('input', e => {
    renderLeadList(e.target.value);
  });

  // Add lead modal
  document.getElementById('addLeadBtn').addEventListener('click', () => {
    document.getElementById('addLeadModal').classList.add('active');
    document.getElementById('newName').focus();
  });
  document.getElementById('modalCancel').addEventListener('click', () => {
    document.getElementById('addLeadModal').classList.remove('active');
  });
  document.getElementById('addLeadModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('active');
  });

  // Save new lead
  document.getElementById('modalSave').addEventListener('click', async () => {
    const lead = {
      name: document.getElementById('newName').value.trim(),
      firm: document.getElementById('newFirm').value.trim(),
      email: document.getElementById('newEmail').value.trim(),
      role: document.getElementById('newRole').value.trim(),
      custom: document.getElementById('newNotes').value.trim(),
      timestamp: new Date().toISOString(),
      source: 'outreach_tool',
      id: 'custom-' + Date.now()
    };

    if (!lead.name && !lead.email && !lead.firm) {
      showToast('Enter at least a name, email, or firm');
      return;
    }

    // Save to server
    try {
      await fetch(`${API_BASE}/api/leads`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(lead)
      });
    } catch {}

    leads.push(lead);
    document.getElementById('leadCount').textContent = leads.length;
    renderLeadList();
    document.getElementById('addLeadModal').classList.remove('active');

    // Clear form
    ['newName','newFirm','newEmail','newRole','newNotes'].forEach(id => document.getElementById(id).value = '');

    // Select the new lead
    selectLead(leads.length - 1);
    showToast(`Added ${lead.name || lead.firm || 'contact'}`);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.getElementById('addLeadModal').classList.remove('active');
    if (e.key === 'n' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      document.getElementById('addLeadBtn').click();
    }
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
